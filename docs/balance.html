<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fyber Balance</title>
    <link rel="stylesheet" href="balance.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="balance-page">

    <div class="page-container">
        
        <div id="view-main-balance">
            <header class="page-header">
                <h1 class="page-title">Баланс</h1>
            </header>

            <div class="card main-balance-card">
                <div class="balance-glow-box">
                    <span class="balance-amount" id="balance-amount">$0<span class="balance-cents">.00</span></span>                </div>
                <button class="withdraw-btn" id="open-withdraw-btn" type="button">Вывод средств</button>
            </div>
            
            <div class="card history-card animate-slide-up">
                <div class="card-header">
                    <span class="card-label">История Профитов</span>
                    <div class="history-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="#e0f2e9">
                            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                        </svg>
                    </div>
                </div>

                <div id="history-list" style="display: none;"></div>

                <div class="empty-state" id="history-empty-state">
                    <div class="folder-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#1f3a2d" stroke-width="1">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                    <p class="empty-text">Здесь появятся<br>ваши профиты</p>
                </div>
            </div>

    </div>


        <div id="view-withdraw" style="display: none;" class="animate-slide-up">
            <header class="page-header">
                <button class="back-btn" id="back-to-balance-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <h1 class="page-title text-faded">Баланс /</h1><h1 class="page-subtitle">Вывод</h1>
            </header>

            <div class="withdraw-section">
                <div class="withdraw-card-inner">
                    <h2 class="withdraw-title">Введите сумму</h2>
                    <div id="error-message" class="error-text">Ошибка: сумма превышает ваш баланс.</div>
                    <div class="input-group">
                        <input type="number" id="withdraw-amount" class="custom-input" placeholder="Сумма в USD">
                    </div>
                    <div class="method-selector">
                        <button class="method-btn active" onclick="selectMethod(this)">На Криптовалюту</button>
                        <button class="method-btn" onclick="selectMethod(this)">На Карту</button>
                    </div>
                    <button id="submit-request-btn" class="submit-request-btn">ПОДАТЬ ЗАЯВКУ</button>
                </div>
            </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <img src="images/dashboard.png" alt="Menu" class="nav-icon">
        </a>

        <a href="#" class="nav-item active">
            <img src="images/balance_white.png" alt="Balance" class="nav-icon">
            <span>Баланс</span>
        </a>

        <a href="profile.html" class="nav-item">
            <img src="images/profile.png" alt="Profile" class="nav-icon">
        </a>
    </nav>

    <script type="module">
        // 1. FIREBASE IMPORTS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // 2. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBWKNOFsaM0VIwZCgz-fxocwjkAY72mefg",
            authDomain: "fyber-mini-app.firebaseapp.com",
            databaseURL: "https://fyber-mini-app-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fyber-mini-app",
            storageBucket: "fyber-mini-app.firebasestorage.app",
            messagingSenderId: "622613200958",
            appId: "1:622613200958:web:061496e31f2bafd352516f",
            measurementId: "G-C720SK2JKJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const auth = getAuth(app);
        signInAnonymously(auth).catch(() => {});
        
        const tg = window.Telegram.WebApp; 

        // 3. ANIMATION FUNCTION (Quintic Ease-Out - Power of 5)
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                
                const runtime = Math.min((timestamp - startTimestamp) / duration, 1);
                
                // Slow down significantly at the end
                const progress = 1 - Math.pow(1 - runtime, 5);
                
                const current = start + (progress * (end - start));
                
                // Formatting
                const valStr = current.toFixed(2);     
                const parts = valStr.split('.');       
                
                // Inject HTML with the dimmer class
                obj.innerHTML = `$${parts[0]}<span class="balance-cents">.${parts[1]}</span>`;

                if (runtime < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    // Final state
                    const endStr = end.toFixed(2);
                    const endParts = endStr.split('.');
                    obj.innerHTML = `$${endParts[0]}<span class="balance-cents">.${endParts[1]}</span>`;
                }
            };
            window.requestAnimationFrame(step);
        }

        document.addEventListener('DOMContentLoaded', () => {
            tg.expand(); 

            // --- VIEW NAVIGATION LOGIC ---
            const balanceView = document.getElementById('view-main-balance');
            const withdrawView = document.getElementById('view-withdraw');
            
            const openWithdrawBtn = document.getElementById('open-withdraw-btn');
            if (openWithdrawBtn) {
                openWithdrawBtn.addEventListener('click', () => {
                    balanceView.style.display = 'none';
                    withdrawView.style.display = 'block';
                    tg.BackButton.show(); 
                });
            }

            const handleBack = () => {
                withdrawView.style.display = 'none';
                balanceView.style.display = 'block';
                tg.BackButton.hide();
            };

            const backBtn = document.getElementById('back-to-balance-btn');
            if(backBtn) backBtn.addEventListener('click', handleBack);

            tg.BackButton.onClick(handleBack);

            // --- SUBMIT WITHDRAWAL LOGIC ---
            const submitBtn = document.getElementById('submit-request-btn');
            if (submitBtn) {
                submitBtn.addEventListener('click', () => {
                    const amountInput = document.getElementById('withdraw-amount');
                    const amount = parseFloat(amountInput.value.trim());
                    const balanceElement = document.getElementById('balance-amount');
                    const currentBalance = parseFloat(balanceElement.innerText.replace(/[$,]/g, '')) || 0;
                    const errorMessage = document.getElementById('error-message');

                    if (!amount || amount <= 0) {
                        tg.showPopup({ title: 'Ошибка', message: 'Пожалуйста, введите корректную сумму.' });
                        return;
                    }

                    if (amount > currentBalance) {
                        errorMessage.style.display = 'block';
                        return;
                    }

                    errorMessage.style.display = 'none';

                    const activeMethodBtn = document.querySelector('.method-btn.active');
                    const method = activeMethodBtn ? activeMethodBtn.textContent : "Не выбран";

                    let currentUsername = localStorage.getItem("fyber_nickname");
                    if (!currentUsername) {
                        const tgUser = tg.initDataUnsafe?.user;
                        currentUsername = tgUser?.username || tgUser?.first_name || "Hidden";
                    }

                    const payload = {
                        action: 'withdrawal_request',
                        amount: amount,
                        method: method,
                        userId: localStorage.getItem("fyber_current_id") || "Unknown",
                        username: currentUsername
                    };

                    tg.sendData(JSON.stringify(payload));
                });
            }

            // --- FIREBASE LIVE BALANCE & ANIMATION ---
            const userId = localStorage.getItem("fyber_current_id");

            if (!userId) {
                // If accessed directly without login, redirect
                window.location.href = "index.html";
            } else {
                const userRef = ref(db, 'balances/' + userId);
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const balanceElement = document.getElementById('balance-amount');
                        if (balanceElement) {
                            // Parse current visible value
                            let startVal = parseFloat(balanceElement.innerText.replace(/[$,]/g, '')) || 0;
                            let endVal = parseFloat(data.balance);

                            if (startVal !== endVal) {
                                // Run Animation: 4000ms (4 seconds)
                                animateValue(balanceElement, startVal, endVal, 1500); 
                            } else {
                                // Static Update (preserve formatting)
                                const endStr = endVal.toFixed(2);
                                const endParts = endStr.split('.');
                                balanceElement.innerHTML = `$${endParts[0]}<span class="balance-cents">.${endParts[1]}</span>`;
                            }
                        }
                    }
                });
            }

            // --- HISTORY LOGIC: FETCH ALL PROFITS ---
            const historyList = document.getElementById('history-list');
            const emptyState = document.getElementById('history-empty-state');
            const currentUserId = localStorage.getItem("fyber_current_id");

            if (currentUserId && historyList) {
                // 1. Create a query to find ALL items where sheet_id == currentUserId
                const profitsRef = ref(db, 'profits');
                const userProfitsQuery = query(profitsRef, orderByChild('sheet_id'), equalTo(currentUserId));

                onValue(userProfitsQuery, (snapshot) => {
                    // Clear the list before re-rendering to avoid duplicates
                    historyList.innerHTML = '';
                    
                    const data = snapshot.val();

                    if (data) {
                        // Data found: Hide empty state, show list
                        emptyState.style.display = 'none';
                        historyList.style.display = 'flex';

                        // 2. Convert object to Array and Sort by Timestamp (Newest First)
                        const profitsArray = Object.values(data).sort((a, b) => {
                            // Convert timestamps to Date objects for comparison
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        });

                        // 3. Loop through EVERY item and create a row
                        profitsArray.forEach(item => {
                            // Format Amount
                            const amount = parseFloat(item.profit).toFixed(2);

                            // Format Date & Time Separately
                            let dateStr = "Unknown";
                            let timeStr = "--:--";
                            
                            try {
                                const dateObj = new Date(item.timestamp);
                                if (!isNaN(dateObj)) {
                                    const day = String(dateObj.getDate()).padStart(2, '0');
                                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                    const year = dateObj.getFullYear();
                                    
                                    const hours = String(dateObj.getHours()).padStart(2, '0');
                                    const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                                    
                                    dateStr = `${day}.${month}.${year}`;
                                    timeStr = `${hours}:${minutes}`;
                                }
                            } catch (e) { console.log("Date error", e); }

                            // Create HTML elements
                            const row = document.createElement('div');
                            row.className = 'history-item';
                            
                            // UPDATED HTML STRUCTURE TO MATCH PHOTO
                            row.innerHTML = `
                                <div class="history-icon-wrapper">
                                    <img src="images/mamont.png" alt="Icon" class="history-mamont-icon">
                                </div>
                                
                                <div class="history-left">
                                    <span class="history-date">${dateStr}</span>
                                    <span class="history-time">${timeStr}</span>
                                </div>
                                
                                <div class="history-right">
                                    <span class="history-amount">+ $${amount}</span>
                                    <span class="history-status">Получено</span>
                                </div>
                            `;
                            
                            // Append to the list
                            historyList.appendChild(row);
                        });

                    } else {
                        // No data found: Show empty state
                        emptyState.style.display = 'flex';
                        historyList.style.display = 'none';
                    }
                });
            }

            // --- NAV ANIMATION CONTROLLER ---
        // Add this inside your existing DOMContentLoaded listener or at the end of your script

        const navItems = document.querySelectorAll('.nav-item');

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                // Check if it's a real link (not the current page "#")
                const href = item.getAttribute('href');
                if (href && href !== '#' && !item.classList.contains('active')) {
                    e.preventDefault(); // Stop immediate reload
                    
                    // 1. Visually reset the currently active item (shrinks it)
                    document.querySelector('.nav-item.active')?.classList.remove('active');
                    
                    // 2. Visually activate the clicked item (expands it)
                    item.classList.add('active');
                    
                    // 3. Wait 300ms for animation to play, then go to page
                    setTimeout(() => {
                        window.location.href = href;
                    }, 300);
                }
            });
        });
        });

        // --- METHOD SELECTION LOGIC ---
        window.selectMethod = function(element) {
            const buttons = document.querySelectorAll('.method-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
        }

        // ======================================================
            // UPDATED NAVIGATION LOGIC (Paste this into script section)
            // ======================================================
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const href = item.getAttribute('href');
                    
                    // Check if it is a valid link to a different page
                    if (href && href !== '#' && !item.classList.contains('active')) {
                        e.preventDefault(); // Stop instant reload
                        
                        // 1. Animate the Bottom Pill (Visual Swap)
                        document.querySelector('.nav-item.active')?.classList.remove('active');
                        item.classList.add('active');
                        
                        // 2. Animate the Whole Page (Fade Out)
                        document.body.classList.add('fade-out');
                        
                        // 3. Wait 350ms for animations to finish, THEN go to next page
                        setTimeout(() => {
                            window.location.href = href;
                        }, 350);
                    }
                });
            });
    </script>
</body>
</html>
