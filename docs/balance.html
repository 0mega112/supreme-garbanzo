<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fyber Balance</title>
    <link rel="stylesheet" href="balance.css">
    <!-- 1. INCLUDE TELEGRAM SCRIPT -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="balance-page">

    <div class="page-container">
        
        <!-- MAIN BALANCE VIEW -->
        <div id="view-main-balance">
            <header class="page-header">
                <h1 class="page-title">Баланс</h1>
            </header>

            <div class="card main-balance-card">
                <div class="balance-glow-box">
                    <span class="balance-amount" id="balance-amount">$0</span>
                </div>
                <button class="withdraw-btn" id="open-withdraw-btn" type="button">Вывод средств</button>
            </div>
            
            <!-- History (simplified for brevity) -->
            <div class="card history-card animate-slide-up">
            <div class="card-header">
                <span class="card-label">История Профитов</span>
                <div class="history-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="#e0f2e9">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                    </svg>
                </div>
            </div>

            <div class="empty-state">
                <div class="folder-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#1f3a2d" stroke-width="1">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <p class="empty-text">Здесь появятся<br>ваши профиты</p>
            </div>
        </div>

    </div>


        <!-- WITHDRAW VIEW -->
        <div id="view-withdraw" style="display: none;" class="animate-slide-up">
            <header class="page-header">
                <button class="back-btn" id="back-to-balance-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <h1 class="page-title text-faded">Баланс /</h1><h1 class="page-subtitle">Вывод</h1>
            </header>

            <div class="withdraw-section">
                <div class="withdraw-card-inner">
                    <h2 class="withdraw-title">Введите сумму</h2>
                    <div class="input-group">
                        <input type="number" id="withdraw-amount" class="custom-input" placeholder="Сумма в USD">
                    </div>
                    <div class="method-selector">
                        <button class="method-btn active" onclick="selectMethod(this)">На Криптовалюту</button>
                        <button class="method-btn" onclick="selectMethod(this)">На Карту</button>
                    </div>
                    <button id="submit-request-btn" class="submit-request-btn">ПОДАТЬ ЗАЯВКУ</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
        </a>
        
        <a href="#" class="nav-item active">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            <span>Баланс</span>
        </a>
        
        <a href="profile.html" class="nav-item">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </a>
    </nav>

    <script type="module">
        // 1. FIREBASE IMPORTS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 2. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBWKNOFsaM0VIwZCgz-fxocwjkAY72mefg",
            authDomain: "fyber-mini-app.firebaseapp.com",
            databaseURL: "https://fyber-mini-app-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fyber-mini-app",
            storageBucket: "fyber-mini-app.firebasestorage.app",
            messagingSenderId: "622613200958",
            appId: "1:622613200958:web:061496e31f2bafd352516f",
            measurementId: "G-C720SK2JKJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tg = window.Telegram.WebApp; // Initialize Telegram WebApp

        document.addEventListener('DOMContentLoaded', () => {
            tg.expand(); // Make sure app is full height

            // --- VIEW NAVIGATION LOGIC ---
            const balanceView = document.getElementById('view-main-balance');
            const withdrawView = document.getElementById('view-withdraw');
            
            document.getElementById('open-withdraw-btn').addEventListener('click', () => {
                balanceView.style.display = 'none';
                withdrawView.style.display = 'block';
                tg.BackButton.show(); // Show native back button
            });

            const handleBack = () => {
                withdrawView.style.display = 'none';
                balanceView.style.display = 'block';
                tg.BackButton.hide();
            };

            // Handle custom back button
            const backBtn = document.getElementById('back-to-balance-btn');
            if(backBtn) backBtn.addEventListener('click', handleBack);

            // Handle Native Telegram Back Button
            tg.BackButton.onClick(handleBack);


            // --- SUBMIT WITHDRAWAL LOGIC ---
            const submitBtn = document.getElementById('submit-request-btn');
            
            submitBtn.addEventListener('click', () => {
                const amountInput = document.getElementById('withdraw-amount');
                const amount = amountInput.value.trim();
                
                // 1. Get Selected Method
                const activeMethodBtn = document.querySelector('.method-btn.active');
                const method = activeMethodBtn ? activeMethodBtn.textContent : "Не выбран";

                // 2. Validation
                if (!amount || parseFloat(amount) <= 0) {
                    tg.showPopup({
                        title: 'Ошибка',
                        message: 'Пожалуйста, введите корректную сумму.'
                    });
                    return;
                }

                // 3. Get User Info (Robust Check)
                // Priority: LocalStorage -> TG Username -> TG FirstName -> "Hidden"
                let currentUsername = localStorage.getItem("fyber_username");
                
                if (!currentUsername) {
                    const tgUser = tg.initDataUnsafe?.user;
                    currentUsername = tgUser?.username || tgUser?.first_name || "Hidden";
                }

                // 4. Prepare Data for Bot
                const payload = {
                    action: 'withdrawal_request',
                    amount: amount,
                    method: method,
                    userId: localStorage.getItem("fyber_current_id") || "Unknown",
                    username: currentUsername
                };

                // 5. Send Data to Bot
                tg.sendData(JSON.stringify(payload));
            });
        });

        // --- METHOD SELECTION LOGIC ---
        // Attached to window so onclick="" in HTML works
        window.selectMethod = function(element) {
            const buttons = document.querySelectorAll('.method-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
        }

        // --- FIREBASE LIVE BALANCE ---
        const userId = localStorage.getItem("fyber_current_id");

        if (!userId) {
            window.location.href = "index.html";
        } else {
            const userRef = ref(db, '/' + userId);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const balanceElement = document.getElementById('balance-amount');
                    if (balanceElement) {
                        balanceElement.textContent = '$' + data.balance; 
                    }
                }
            });
        }
    </script>
</body>
</html>