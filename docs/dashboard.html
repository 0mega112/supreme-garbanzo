<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fyber Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body class="dashboard-page">

    <div class="dashboard-container">
        
        <!-- Header -->
        <header class="dash-header">
            <h1 class="welcome-text">
                <span class="line-bold">Добро пожаловать</span><br>
                <span class="line-regular">в личный кабинет</span>
            </h1>
            <div class="brand-container">
                <img src="images/box.png" alt="Fyber Logo" class="main-logo">
            </div>
        </header>

        <!-- Balance Card -->
        <div class="card balance-card">
            <div class="card-header">
                <span class="card-label">Общий Баланс</span>
                <a href="balance.html" class="details-link">Подробнее ></a>
            </div>
            <div class="balance-display-box">
                <span id="display-balance" class="balance-amount">$0<span class="balance-cents">.00</span></span>            </div>
        </div>

        <!-- Profile Card -->
        <div class="card profile-card">
            <div class="profile-icon-box">
                <img src="images/user.png" alt="User Icon" class="user-avatar">
            </div>
            <div class="profile-info">
                <h2 class="username" id="display-username"></h2>
                <p class="user-id">ID: <span id="display-id">...</span></p>
                <button class="profile-btn" onclick="window.location.href='profile.html'">Профиль</button>            </div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active">
            <img src="images/dashboard_white.png" alt="Menu" class="nav-icon">
            <span>Меню</span>
        </a>

        <a href="balance.html" class="nav-item">
            <img src="images/balance.png" alt="Balance" class="nav-icon">
        </a>

        <a href="profile.html" class="nav-item">
            <img src="images/profile.png" alt="Profile" class="nav-icon">
        </a>
    </nav>

    <script type="module">
        // 1. FIREBASE IMPORTS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 2. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBWKNOFsaM0VIwZCgz-fxocwjkAY72mefg",
            authDomain: "fyber-mini-app.firebaseapp.com",
            databaseURL: "https://fyber-mini-app-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fyber-mini-app",
            storageBucket: "fyber-mini-app.firebasestorage.app",
            messagingSenderId: "622613200958",
            appId: "1:622613200958:web:061496e31f2bafd352516f",
            measurementId: "G-C720SK2JKJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 3. ANIMATION FUNCTION (Quintic Ease-Out)
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                
                const runtime = Math.min((timestamp - startTimestamp) / duration, 1);
                
                // --- CHANGED HERE: Power of 5 (Quintic) for extreme slow-down ---
                const progress = 1 - Math.pow(1 - runtime, 5);
                
                const current = start + (progress * (end - start));
                
                // Formatting
                const valStr = current.toFixed(2);     
                const parts = valStr.split('.');       
                
                // Inject HTML with the dimmer class
                obj.innerHTML = `$${parts[0]}<span class="balance-cents">.${parts[1]}</span>`;

                if (runtime < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    // Final state: ensure exact value and correct style
                    const endStr = end.toFixed(2);
                    const endParts = endStr.split('.');
                    obj.innerHTML = `$${endParts[0]}<span class="balance-cents">.${endParts[1]}</span>`;
                }
            };
            window.requestAnimationFrame(step);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedName = localStorage.getItem("fyber_nickname");
            if (savedName) document.getElementById('display-username').textContent = savedName;
            
            // 4. GET USER ID & CHECK LOGIN
            const userId = localStorage.getItem("fyber_current_id");
            const displayIdEl = document.getElementById('display-id');

            if (!userId) {
                window.location.href = "index.html";
                return;
            }

            if(displayIdEl) displayIdEl.textContent = userId;

            // 5. FIREBASE LISTENER
            const userRef = ref(db, 'balances/' + userId);

            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
          
                if (data) {
                    const balanceElement = document.getElementById('display-balance');

                    if (balanceElement) {
                        // Use innerText to grab just the visible text, remove symbols
                        let startVal = parseFloat(balanceElement.innerText.replace(/[$,]/g, '')) || 0;
                        let endVal = parseFloat(data.balance);

                        if (startVal !== endVal) {
                            // CHANGED: 4000ms (4 seconds) for a long, smooth finish
                            animateValue(balanceElement, startVal, endVal, 4000); 
                        } else {
                            // Static update
                            const endStr = endVal.toFixed(2);
                            const endParts = endStr.split('.');
                            balanceElement.innerHTML = `$${endParts[0]}<span class="balance-cents">.${endParts[1]}</span>`;
                        }
                    }
              
                    // const nameElement = document.getElementById('display-username');
                    
                    // const savedName = localStorage.getItem("fyber_nickname");
                    // alert(savedName)
                    // document.getElementById('display-username').textContent = savedName;
                }
            });

            // ======================================================
            // UPDATED NAVIGATION LOGIC (Paste this into script section)
            // ======================================================
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const href = item.getAttribute('href');
                    
                    // Check if it is a valid link to a different page
                    if (href && href !== '#' && !item.classList.contains('active')) {
                        e.preventDefault(); // Stop instant reload
                        
                        // 1. Animate the Bottom Pill (Visual Swap)
                        document.querySelector('.nav-item.active')?.classList.remove('active');
                        item.classList.add('active');
                        
                        // 2. Animate the Whole Page (Fade Out)
                        document.body.classList.add('fade-out');
                        
                        // 3. Wait 350ms for animations to finish, THEN go to next page
                        setTimeout(() => {
                            window.location.href = href;
                        }, 350);
                    }
                });
            });
        });
    </script>
</body>
</html>