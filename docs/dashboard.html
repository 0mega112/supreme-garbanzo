<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fyber Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body class="dashboard-page">

    <div class="dashboard-container">
        
        <!-- Header -->
        <header class="dash-header">
            <h1 class="welcome-text">
                <span class="line-bold">Добро пожаловать</span><br>
                <span class="line-regular">в личный кабинет</span>
            </h1>
            <div class="brand-container">
                <img src="images/box.png" alt="Fyber Logo" class="main-logo">
            </div>
        </header>

        <!-- Balance Card -->
        <div class="card balance-card">
            <div class="card-header">
                <span class="card-label">Общий Баланс</span>
                <a href="balance.html" class="details-link">Подробнее ></a>
            </div>
            <div class="balance-display-box">
                <span id="display-balance" class="balance-amount">$0</span>
            </div>
        </div>

        <!-- Profile Card -->
        <div class="card profile-card">
            <div class="profile-icon-box">
                <img src="images/user.png" alt="User Icon" class="user-avatar">
            </div>
            <div class="profile-info">
                <h2 class="username" id="display-username">ЗАГРУЗКА...</h2>
                <p class="user-id">ID: <span id="display-id">...</span></p>
                <button class="profile-btn" onclick="window.location.href='profile.html'">Профиль</button>            </div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span>Меню</span>
        </a>
        <a href="balance.html" class="nav-item">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        </a>
        <a href="profile.html" class="nav-item">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </a>
        
    </nav>

    <script type="module">
        // 1. FIREBASE IMPORTS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 2. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBWKNOFsaM0VIwZCgz-fxocwjkAY72mefg",
            authDomain: "fyber-mini-app.firebaseapp.com",
            databaseURL: "https://fyber-mini-app-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fyber-mini-app",
            storageBucket: "fyber-mini-app.firebasestorage.app",
            messagingSenderId: "622613200958",
            appId: "1:622613200958:web:061496e31f2bafd352516f",
            measurementId: "G-C720SK2JKJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        document.addEventListener('DOMContentLoaded', () => {
            
            // 3. GET USER ID & CHECK LOGIN
            const userId = localStorage.getItem("fyber_current_id");
            const displayIdEl = document.getElementById('display-id');

            if (!userId) {
                window.location.href = "index.html";
                return;
            }

            // Show ID immediately from local storage while loading
            if(displayIdEl) displayIdEl.textContent = userId;

            console.log("Listening for updates for user:", userId);

            // 4. FIREBASE LISTENER
            const userRef = ref(db, '/' + userId);

            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
          
                if (data) {
                    const balanceElement = document.getElementById('display-balance');
                    const nameElement = document.getElementById('display-username');

                    // A. Update Name
                    if (nameElement) {
                        nameElement.innerText = data.username || "USER";
                    }

                    // B. Animate Balance (From 0 to Target)
                    if (balanceElement) {
                        const targetBalance = parseInt(data.balance, 10) || 0;
                        // Run the counting animation
                        animateValue(balanceElement, 0, targetBalance, 2500); 
                    }
                }
            });
        });

        /**
         * ANIMATION FUNCTION
         * counts from start to end, slowing down at the end
         */
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                
                // Calculate progress (0 to 1)
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);

                // --- EASING FORMULA (EaseOutExpo) ---
                // This makes the counter start fast and slow down heavily at the end
                const easeProgress = (progress === 1) ? 1 : 1 - Math.pow(2, -10 * progress);

                // Calculate current number
                const currentVal = Math.floor(easeProgress * (end - start) + start);

                // Update Text (Format: 10 500 $)
                obj.textContent = currentVal.toLocaleString('ru-RU') + ' $';

                // Continue loop if not finished
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    // Ensure it ends on the exact number
                    obj.textContent = end.toLocaleString('ru-RU') + ' $';
                }
            };

            window.requestAnimationFrame(step);
        }
    </script>
</body>
</html>